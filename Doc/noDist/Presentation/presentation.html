<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<title>Usage implicit de MPI dans ScalFmm</title>
<!-- 2016-03-21 lun. 15:27 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Martin Khannouz" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Usage implicit de MPI dans ScalFmm</h1>
<div id="table-of-contents">
<h2>Table des matières</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Implémentation mpi implicite très naïve</a></li>
<li><a href="#sec-2">2. Implémentation moins naïve</a></li>
<li><a href="#sec-3">3. Reproduction du mapping mpi explicite</a>
<ul>
<li><a href="#sec-3-1">3.1. Premier problème des groupes</a></li>
<li><a href="#sec-3-2">3.2. Solution retenue</a></li>
<li><a href="#sec-3-3">3.3. Validation des résultats</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. Observation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Et après ?</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Implémentation mpi implicite très naïve</h2>
<div class="outline-text-2" id="text-1">
<p>
Cette première version avait pour principal but de découvrir et à prendre en main les fonctions de StarPU MPI.
Les premières étant starpu_mpi_init et starpu_mpi_shutdown. Mais rapidement ont suivies les fonctions pour <i>tagger</i> les <i>handles</i> de StarPU et les ajouter à des nœuds MPI.
À cela c'est ajouté la transformation de tous les appels à starpu_insert_task ou starpu_task_submit par starpu_mpi_insert_task.
</p>

<p>
Par soucis de simplicité chaque nœud MPI possède l'intégralité de l'arbre, même si ce n'est pas une solution viable sur le long terme.
Pour vérifier que tout fonctionnait correctement, je me suis amusé à <i>mapper</i> toutes les données sur un premier nœud MPI et toutes les tâches sur un second.
J'ai ensuite pu valider que l'arbre du premier nœud avait les bons résultats et que le second nœud n'avait que des erreurs.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Implémentation moins naïve</h2>
<div class="outline-text-2" id="text-2">
<p>
Dans l'idée de créer une version 0 un brin potable qui puisse faire du calcul avec plus de deux nœuds MPI, j'ai créé une fonction de <i>mapping</i> des données.
Elle consistait à partager chaque niveau entre tous les processus de la manière la plus équitable possible.
</p>


<div class="figure">
<p><img src="./naive_split.png" alt="naive_split.png" />
</p>
<p><span class="figure-number">Figure&nbsp;1&nbsp;:</span> Division de chaque niveau entre chaque processus. Groupe de l'arbre de taille 4.</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Reproduction du mapping mpi explicite</h2>
<div class="outline-text-2" id="text-3">
<p>
Pour pouvoir effectuer des comparaisons il était nécessaire de reproduire le même <i>mapping</i> de tâches la version MPI explicite.
Dans le cas de la version implicite telle qu'elle est actuellement implémentée, le <i>mapping</i> des données infère le <i>mapping</i> de tâches.
La façon la plus simple de procéder est de faire en sorte que les particules se retrouvent sur les mêmes nœuds MPI.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Premier problème des groupes</h3>
<div class="outline-text-3" id="text-3-1">
<p>
La disposition des particules sur les nœuds MPI étant décidé par un tri distribué, il était plus judicieux de sauvegarder le <i>mapping</i> des particules dans un fichier puis de le charger (dans la version implicite) et d'utiliser ce <i>mapping</i> pour influer le <i>mapping</i> au niveau de la version implicite.
Le soucis du tri distribué est qu'il essaye d'équilibrer les particules sur les nœuds sans tenir compte des groupes de l'arbre groupé (<i>group tree</i>).
</p>


<div id="fig:SED-HR4049" class="figure">
<p><img src="./group_issue1.png" alt="group_issue1.png" />
</p>
<p><span class="figure-number">Figure&nbsp;2&nbsp;:</span> Problème issuent de la constitution des groupes.</p>
</div>

<p>
Or le <i>mapping</i> des données est fait avec la granularité des groupes de l'arbre groupé.
</p>

<p>
Une première solution serait de modifier un peu l'algorithme de l'arbre pour le forcer à faire des groupes un peu plus petit de telle sorte qu'ils correspondent aux groupes de la version MPI explicite.
Soucis, quand il faudra remonter dans l'arbre, que faire des cellules qui sont présentes sur plusieurs nœuds MPI, que faire de la racine ?
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Solution retenue</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Plutôt que d'essayer de reproduire un <i>mapping</i> de données identique à celui de la version explicite quel que soit les particules, nous avons choisi de limiter le nombre de cas reproductibles et de ségmenter ce <i>mapping</i> par niveau.
Ainsi avec un arbre parfait où chaque indice de morton possède le même nombre de particules, il est possible de reproduire le même <i>mapping</i> de données sur un certain de nombre de niveaux.
Ce nombre varie en fonction de la taille des groupes de l'arbre groupé.
</p>


<div id="fig:SED-HR4049" class="figure">
<p><img src="./morton_box_center.png" alt="morton_box_center.png" />
</p>
<p><span class="figure-number">Figure&nbsp;3&nbsp;:</span> Méthode pour générer une particule à un indice de Morton donné.</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Validation des résultats</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Pour valider ces résultats, j'ai réutilisé le système de nom de tâches fait pour simgrid. Ainsi j'ai pu indiquer, dans un fichier des informations à propos de chaque tâche.
Les indices de Morton ainsi que les nœuds MPI sur lesquels elles s'exécutent. 
</p>
</div>

<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> Observation</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Si l'on fait exception des niveaux où l'on sait que des erreurs de tâches se trouveront, on a :
</p>
<ul class="org-ul">
<li>Plus de tâches dans la version explicite car elle a des tâches (P2P, M2L) symetriques.
</li>
<li>Toutes les tâches issuent de l'algorithme implicite se retrouvent dans l'ensemble des tâches explicite.
</li>
<li>Toutes les tâches sont au moins mapper sur le même nœud MPI. Les tâches symetriques étant parfois mappé sur deux nœuds différents.
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Et après ?</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Comparaison des performances
<ul class="org-ul">
<li>Répartition des GFlop
</li>
<li>Répartition du temps de calcul
</li>
<li>Mémoire utilisée par nœud
</li>
</ul>
</li>
<li>Étude d'autres <i>mapping</i>
</li>
<li>Limiter l'empreinte mémoire
<ul class="org-ul">
<li>Ne pas allouer les cellules numériques si ce n'est pas necessaire (<i>up</i> et <i>down</i>)
</li>
<li>Ne pas allouer les cellules symboliques si ce n'est pas necessaire
</li>
<li>Distribuer l'arbre
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Auteur: Martin Khannouz</p>
<p class="date">Created: 2016-03-21 lun. 15:27</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
